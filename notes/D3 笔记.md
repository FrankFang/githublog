
# D3 笔记

# Selections 是如何工作的？

除了说明如何使用 selections，我还会解释 selections 是如何实现的。虽然要费些唇舌，但是我们能借此拨开 D3 的迷雾，更好地掌握数据驱动文档的理念。

本文结构初看貌似混乱。我会首先说明 selections 的运行方式，在文章末尾阐述 D3 的设计理念。

D3 是一个可视化库。所以本文也会用可视化的图例来解释它。在下文的图例中，左边的图例会展示 selections 的结构，右边的图例用来展示数据的结构。

<svg width="740" height="120" style="margin:1em -10px;">
  <g transform="translate(9.5,9.5)">
	<rect fill="#eee" stroke="#ccc" stroke-dasharray="2,2" width="355" height="100"></rect>
	<rect fill="#eee" stroke="#ccc" stroke-dasharray="2,2" x="365" width="355" height="100"></rect>
	<rect fill="#a1d99b" fill-opacity=".8" stroke="#71a76c" stroke-dasharray="2,2" y="10" x="300" width="120" height="80"></rect>
	<text x="178" text-anchor="middle" y="50" dy=".35em">selections 放在左边</text>
	<text x="360" text-anchor="middle" y="50" dy=".35em">交互放在中间</text>
	<text x="543" text-anchor="middle" y="50" dy=".35em">数据放在右边</text>
  </g>
</svg>

圆角矩形 <span style="display:inline-block;position:relative;width:75px;"><svg style="position:absolute;top:-17px;" class="node" width="75" height="22"><g transform="translate(1,1)" class="datum"><rect rx="6" ry="6" width="73" height="20"></rect><text x="35" y="10" dy=".35em" text-anchor="middle">比如这样</text></g></svg></span> 表示 JavaScript 对象，包括对象（`{foo: 16}`）、字符串（`"hello"`）、数组（`[1,2,3]`）和 DOM 元素。某些对象会用特殊的圆角矩形表示，如 
<span style="display:inline-block;position:relative;width:55px;"><svg style="position:absolute;top:-17px;" class="node" width="55" height="22"><g transform="translate(1,1)" class="selection"><rect rx="6" ry="6" width="53" height="20"></rect><text x="26" y="10" dy=".35em" text-anchor="middle">selection</text></g></svg></span>
<span style="display:inline-block;position:relative;width:55px;"><svg style="position:absolute;top:-17px;" class="node" width="55" height="22"><g transform="translate(1,1)" class="array"><rect rx="6" ry="6" width="53" height="20"></rect><text x="26" y="10" dy=".35em" text-anchor="middle">数组</text></g></svg></span>
和 
<span style="display:inline-block;position:relative;width:55px;"><svg style="position:absolute;top:-17px;" class="node" width="55" height="22"><g transform="translate(1,1)" class="element"><rect rx="6" ry="6" width="53" height="20"></rect><text x="26" y="10" dy=".35em" text-anchor="middle">element</text></g></svg></span>
。

对象的引用用直线（<span style="display:inline-block;position:relative;width:55px;"><svg style="position:absolute;top:-17px;" class="link" width="55" height="22"><line x1="1" x2="54" y1="11" y2="11"></line></svg></span>）表示。例如，

\`\`\`
var array = [42];
\`\`\`
表示为

<svg width="800" height="24" style="margin: 1em 0px 1em -40px;"><g class="left" transform="translate(40,0)"><g class="link"><path class="to-datum from-array" d="M42.04800033569336,12C71.02400016784668,12 71.02400016784668,12 100,12"></path></g><g class="node"><g class="array" transform="translate(0,12)"><rect ry="6" rx="6" y="-10" height="20" width="42.04800033569336"></rect><text dy=".35em" x="6">array</text></g><g class="datum" transform="translate(100,12)"><rect ry="6" rx="6" y="-10" height="20" width="32"></rect><text dy=".35em" x="6">42</text></g></g></g></svg>

图例对应的代码一般就放在图例上方。

我们开始吧。

## Array 的子类

也许有人告诉你 selections 是 Array。这是错的。
第一个原因，selections 其实是 Array 的子类。这个子类提供一些方法让我们来操作所选的元素，比如设置属性（attribute）和样式（style）。当然 selections 也继承了 Array 的方法。不过一般来说你不需要使用 Array 的方法，因为 D3 提供了更为便利的接口。一些方法还被重写了，比如 `selection.filter` 和 `selection.sort`。





